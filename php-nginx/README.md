# PHP Nginx

## The Basics
This image should serve as a base for building an image for a web app written in PHP, place your code in `/usr/src/app`
and the image should boot exposing nginx acting as a reverse proxy for php-fpm on port 8443, that's it for a basic setup. 

## Configuration
The basic setup is intended to allow users to get started quickly but that doesn't mean there aren't plenty of knobs to
adjust for production environments. Because there are so many options for configuration they will be broken down into
three sections: nginx, php-fpm, and init scripts.

### Nginx
The base Nginx configuration file is generated by a script (`/entrypoint.d/20-configure-nginx.py`) when the container
boots, this script reads a handful of environment variables then writes the generated configuration to
`/usr/src/nginx/nginx.conf`. In addition, a series of `include` statements are present in the generated config file,
these include statements will read any `.conf` files present in the specified directories.

*Included Directories*
 * `/usr/src/nginx/main.d`: included in the top level of the generated config, use to set global options
 * `/usr/src/nginx/conf.d`: included inside the body of the `http` block defining
 * `/usr/src/nginx/location.d`: included inside the `location` blocks defined for handling routing 

*Environment Variables*
| Variable Name | Default Value | Description |
|---|---|---|
| APP_DOMAIN | app.invalid | The domain name to find the server at, used to route connections to the correct vhost when more than one server is defined. |
| CG_ENVIRONMENT | local | The name of the deployed environment, leave set to local for development use and let your deploy system define this in those environments. |
| CG_HTTP_PORT | 8080 | The port to bind to for http, when set to a different value from CG_HTTPS_PORT a redirect from http to https will automatically be created on this port. |
| CG_HTTPS_PORT | 8443 | The port to bind to for https traffic, the default generated configuration assumes TLS termination will be handled at the load balancer. |
| NGINX_WORKER_COUNT | auto | The number of worker processes for nginx to run. The default, `auto`, will run one worker per processor core. |
| NGINX_WORKER_CONNECTIONS | 1024 | Sets the maximum number of simultaneous connections that can be opened by a worker process. This is a combined limit for both client connections and proxied servers. |
| NGINX_MAX_UPLOAD_SIZE | 10m | Sets the maximum allowed size of the client request body, specified in the “Content-Length” request header field. Set to 0 to disable content size checking (not recommended). | 

### PHP-FPM
The PHP-FPM configuration file is generated by a script (`/entrypoint.d/10-configure-fpm.py`) when the container boots,
it writes the file out to `/usr/src/php/fpm/default.conf`. The script reads a handful of environment variables to alter
how fpm behaves.
| Variable Name | Default Value | Description |
|---|---|---|
| FPM_PM_MODE | dynamic | Sets `pm` |
| FPM_PING_PATH | N/A | Sets `ping.path` |
| FPM_STATUS_PATH | N/A | Sets `pm.status_path` |
| FPM_MAX_CHILDREN | 5 | Sets `pm.max_children` |
| FPM_START_CHILDREN | 2 | Sets `pm.start_servers` |
| FPM_MIN_SPARE_CHILDREN | 1 | Sets `pm.min_spare_servers` |
| FPM_MAX_SPARE_CHILDREN | 3 | Sets `pm.max_spare_servers` |
| FPM_CHILD_MAX_REQUESTS | 0 | Sets `pm.max_requests` |

### Init scripts
The final way to configure the image is through init scripts placed in `/entrypoint.d`, any shell, PHP, or python
scripts placed in this directory will be executed in lexical order according to the container's locale. These can be
used to generate configuration for the application or override the behavior of the default nginx and FPM configuration
generation.
